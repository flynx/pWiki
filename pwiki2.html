<!DOCTYPE html>
<html>
<!--html manifest="pwiki.appcache"-->
<head>
<title>pWiki</title>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<link rel="manifest" href="manifest.json">

<link rel="prefetch" href="css/fonts/Open_Sans/OpenSans-Bold.ttf">
<link rel="prefetch" href="css/fonts/Open_Sans/OpenSans-BoldItalic.ttf">
<link rel="prefetch" href="css/fonts/Open_Sans/OpenSans-ExtraBold.ttf">
<link rel="prefetch" href="css/fonts/Open_Sans/OpenSans-ExtraBoldItalic.ttf">
<link rel="prefetch" href="css/fonts/Open_Sans/OpenSans-Italic.ttf">
<link rel="prefetch" href="css/fonts/Open_Sans/OpenSans-Light.ttf">
<link rel="prefetch" href="css/fonts/Open_Sans/OpenSans-LightItalic.ttf">
<link rel="prefetch" href="css/fonts/Open_Sans/OpenSans-Regular.ttf">
<link rel="prefetch" href="css/fonts/Open_Sans/OpenSans-Semibold.ttf">
<link rel="prefetch" href="css/fonts/Open_Sans/OpenSans-SemiboldItalic.ttf">

<link rel="stylesheet" href="css/fonts.css">

</head>

<style>
</style>

<!-- XXX do we need this??? -->
<script src="bootstrap.js"></script>

<!--script data-main="pwiki2" src="ext-lib/require.js"></script-->
<script src="ext-lib/require.js"></script>
<script>


var makeFallbacks = 
function(paths, search=['lib']){
	return Object.entries(paths)
		.map(function([key, path]){
			// package...
			if(path.endsWith('/')){
				return [key, path] }
			return [
				key,
				[
					path,
					...search
						.map(function(base){
							return base +'/'+ path.split(/[\\\/]+/g).pop() }),
				]
			] })
		.reduce(function(res, [key, value]){
			res[key] = value
			return res }, {}) }


require.config({
	paths: {
		...makeFallbacks({
			'ig-doc': 'node_modules/ig-doc/doc',
			'ig-stoppable': 'node_modules/ig-stoppable/stoppable',
			'object-run': 'node_modules/object-run/run',
			'ig-object': 'node_modules/ig-object/object',
		}),

		// packages...
		'ig-types': [
			'node_modules/ig-types',
			'lib/types',
		],

		// external stuff...
		...makeFallbacks({
			'jszip': 'node_modules/jszip/dist/jszip',
			'pouchdb': 'node_modules/pouchdb/dist/pouchdb',
			'showdown': 'node_modules/showdown/dist/showdown',
		}, ['ext-lib']),
	},
	packages: [
		'ig-types',
	]
})


document.pwikiloaded = new Event('pwikiloaded')


// start loading pWiki...
require(['./browser'], function(pwiki){ 
	pwiki = window.pwiki = pwiki.pwiki 

	pwiki.dom = document.querySelector('#pWiki')

	// handle location.hash/history (both directions)
	window.addEventListener('hashchange', function(evt){
		evt.preventDefault()
		var [path, hash] = location.hash.slice(1).split('#')
		path = path.trim() == '' ? 
			pwiki.path
			//'/'
			: path
		// treat links as absolute unless explicitly relative...
		path = /^\.\.?([\\\/].*)?$/.test(path) ?
			path
			: '/'+path
		pwiki.path = [path, hash] })
	pwiki
		.onNavigate(function(){
			// NOTE: we do not need to directly update location.hash here as
			//		that will push an extra history item...
			history.replaceState(
				{path: this.path}, 
				this.title, 
				'#'+this.path 
					+(this.hash ? 
						'#'+this.hash 
						: ''))
			// NOTE: we are intentionally not awaiting for this -- this 
			//		separates the navigate and load events...
			this.refresh() })
		.onLoad(function(evt){
			// handle title...
			document.querySelector('title').innerHTML = this.title
			// scroll to anchor element...
			this.hash
				&& this.dom
					.querySelector('#'+ this.hash)
					.scrollIntoView() })

	// show current page...
	pwiki.path = location.hash.slice(1)
}) 

</script>

<body>

<!-- XXX need to add something passive but animated here... -->
<div id="pWiki">Loading...</div>

</body>
</html>

<!-- vim:set sw=4 ts=4 : -->
