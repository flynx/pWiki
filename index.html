<!DOCTYPE html>
<html>
<head>
<title>pWiki</title>
</head>
<style>
</style>

<script src="ext-lib/jquery.js"></script>
<script src="ext-lib/pouchdb.min.js"></script>
<script src="ext-lib/peer.min.js"></script>
<script src="wiki.js"></script>

<script>

var clear = () => {
	delete localStorage['wiki-data']
	delete localStorage['wiki-location']
}

var reload = () => {

	$('.wiki')
		.html(Wiki.title[0] == '_' ? Wiki.text : Wiki.get('./_view').text)
		.ready(update_editor)

	// XXX save...
	localStorage['wiki-data'] = JSON.stringify(Wiki.__wiki_data)
	localStorage['wiki-location'] = Wiki.location

	$('title').text(Wiki.location)
}

var update_editor = function(){
	// XXX make this update on enter...
	$('.title')
		.on('blur', () => { 
			//Wiki.title = $('.title').text() 
			//reload()
		})

	// live update text...
	// XXX is this the right way to go for large documents???
	$('.text')
		.focus(function(){
			console.log('EDITING:', Wiki.path)

			$(this)
				.prop('contenteditable', 'true')
				.html(Wiki.raw)

			//reload()
		})
		.on('keyup', () => { 
			console.log('SAVING:', Wiki.path)
			//if($(this).prop('contenteditable') == 'true'){
			//	Wiki.raw = clearWikiWords($('.text').clone()).html() 
			//}
		})
		// XXX do this live, but on a timeout after user input...
		// XXX need to place the cursor in the same position...
		.blur(() => { 
			$(this).removeAttr('contenteditable')
			//reload() 
		})
}

var go = (path) => {
	console.log('GO:', path)

	path = path.trim()
	path = path[0] == '[' ? path.slice(1, -1) : path

	Wiki.location = path

	history.pushState({
			wikipath: Wiki.location
		}, 
		Wiki.title, 
		window.location)

	reload()
}

$(() => {
	$(window).on('popstate', function(evt){
		event.state 
			&& event.state.wikipath 
			&& go(event.state.wikipath)
	})

	// load stored data...
	Wiki.__wiki_data = localStorage['wiki-data'] ?
		JSON.parse(localStorage['wiki-data']) 
		: data
	Wiki.__wiki_data.__proto__ = data

	Wiki.location = localStorage['wiki-location'] || Wiki.location


	reload()

	//update_editor()

	// XXX need to resolve relative hashes...
	$(window).on('hashchange', function(evt){
		evt.preventDefault()

		var path = location.hash.slice(1)
		var hash = path.split('#')
		path = hash.shift()
		hash = hash.pop() || ''

		go(path)

		if(hash.length > 0){
			// XXX focus anchor...
		}
	})
})
</script>

<body>

<div class="wiki"></div>

</body>
</html>
<!-- vim:set sw=4 ts=4 : -->
